<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary SEO Meta Tags -->
    <title>Beneath Air | Interactive 4K Fractal Visualizer</title>
    <meta name="description" content="Experience Beneath Air, a high-performance interactive fractal visualizer. Explore infinite Mandelbox variations, customize mathematical parameters in real-time, and export stunning 4K wallpapers. A masterclass in WebGL performance and vibe coding.">
    <meta name="keywords" content="Beneath Air, WebGL, Fractal Visualizer, Mandelbox, Math Art, Real-time Rendering, 4K Wallpapers, Chris Pirillo, Generative Art, Shader Art">
    <meta name="author" content="Chris Pirillo">
    <link rel="canonical" href="https://pirillo.com/arcade/skybound-shader.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pirillo.com/arcade/skybound-shader.html">
    <meta property="og:title" content="Beneath Air | Interactive Fractal Art Engine">
    <meta property="og:description" content="An immersive mathematical journey. Manipulate space and time with real-time fractal folding and export your creations in 4K.">
    <meta property="og:image" content="https://pirillo.com/arcade/images/skybound-shader.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://pirillo.com/arcade/skybound-shader.html">
    <meta property="twitter:title" content="Beneath Air | Interactive Fractal Art Engine">
    <meta property="twitter:description" content="Explore infinite mathematical landscapes in high performance. Created by @ChrisPirillo.">
    <meta property="twitter:image" content="https://pirillo.com/arcade/images/skybound-shader.png">
    <meta name="twitter:creator" content="@ChrisPirillo">

    <!-- Structured Data: WebPage / Tool -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Beneath Air",
      "description": "An interactive WebGL fractal visualizer using Mandelbox variations.",
      "url": "https://pirillo.com/arcade/skybound-shader.html",
      "image": "https://pirillo.com/arcade/images/skybound-shader.png",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Chris Pirillo"
      }
    }
    </script>

    <!-- Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1CQ4D3VQ3L');
    </script>

    <style>
        :root {
            --bg-menu: rgba(10, 10, 10, 0.9);
            --text-main: #f0f0f0;
            --accent: #00ffcc;
            --border: rgba(255, 255, 255, 0.15);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', Courier, monospace;
            font-display: swap;
            user-select: none;
            -webkit-user-select: none;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            aspect-ratio: auto;
        }

        #transition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.4s ease-in-out;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #menu-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: var(--bg-menu);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #menu-btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        #menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: white;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #menu-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        #menu-btn.open span:nth-child(2) { opacity: 0; }
        #menu-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

        #settings-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 340px;
            height: 100%;
            background: var(--bg-menu);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            overflow-y: auto;
            padding: 90px 25px 40px 25px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #settings-panel.open {
            transform: translateX(0);
        }

        h1, h2 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 12px;
        }

        label {
            display: flex;
            justify-content: space-between;
            color: #ccc;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        label span:last-child {
            color: var(--accent);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 0;
            background: var(--accent);
            cursor: pointer;
            margin-top: -5px; 
            border: 2px solid #000;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        input[type="range"]:focus {
            outline: none;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: auto;
        }

        button {
            background: transparent;
            border: 1px solid var(--border);
            color: white;
            padding: 14px;
            border-radius: 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.2s;
            font-family: 'Courier New', Courier, monospace;
        }

        button:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        button:active {
            transform: translateY(2px);
        }

        .full-width {
            grid-column: span 2;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #fff;
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        input[type="checkbox"] {
            appearance: none;
            width: 40px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        
        input[type="checkbox"]:checked {
            background: var(--accent);
        }
        
        input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        
        input[type="checkbox"]:checked::before {
            transform: translateX(20px);
            background: #000;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>

    <main id="canvas-container">
        <canvas id="glcanvas" aria-label="A generative fractal visualization that evolves over time"></canvas>
        <div id="transition-overlay"></div>
    </main>

    <header id="ui-layer">
        <button id="menu-btn" aria-label="Toggle Controls Menu" aria-expanded="false" aria-controls="settings-panel">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <section id="settings-panel" role="region" aria-labelledby="controls-heading">
            <h2 id="controls-heading">Beneath Air Parameters</h2>
            
            <div id="controls-container"></div>

            <div class="control-group toggle-row">
                <span>AUTO RANDOMIZE</span>
                <input type="checkbox" id="auto-advance" aria-label="Toggle Auto Randomize">
            </div>
            <div class="control-group">
                <label for="auto-interval"><span>Interval (sec)</span><span id="interval-val" aria-live="polite">5</span></label>
                <input type="range" id="auto-interval" min="2" max="20" step="1" value="5">
            </div>

            <div class="btn-grid">
                <button id="btn-random">Randomize</button>
                <button id="btn-reset">Reset Default</button>
                <button id="btn-export" class="full-width">Save 4K Wallpaper</button>
            </div>
        </section>
    </header>

    <h1 class="sr-only">Beneath Air - Interactive WebGL Fractal Engine</h1>

    <!-- WebGL Shader Logic (AS-IS) -->
    <script id="vs" type="x-shader/x-vertex">
        #version 300 es
        in vec4 position;
        void main() {
            gl_Position = position;
        }
    </script>

    <script id="fs" type="x-shader/x-fragment">
        #version 300 es
        precision highp float;

        out vec4 outColor;
        
        uniform vec2 iResolution;
        uniform float iTime;
        
        uniform float uScale;       
        uniform float uFold1X;      
        uniform float uFold1Y;      
        uniform float uFold1Z;      
        uniform float uColorFreq;   
        uniform float uColorSpeed;  
        uniform float uCamZoom;     
        uniform float uCamY;        

        vec3 hsv(float h, float s, float v) {
            vec4 t = vec4(1.0, 2.0/3.0, 1.0/3.0, 3.0);
            vec3 p = abs(fract(vec3(h) + t.xyz) * 6.0 - vec3(t.w));
            return v * mix(vec3(t.x), clamp(p - vec3(t.x), 0.0, 1.0), s);
        }

        mat3 rotate3D(float angle, vec3 axis) {
            vec3 a = normalize(axis);
            float s = sin(angle);
            float c = cos(angle);
            float oc = 1.0 - c;
            return mat3(
                oc*a.x*a.x + c,      oc*a.x*a.y + a.z*s,  oc*a.z*a.x - a.y*s,
                oc*a.x*a.y - a.z*s,  oc*a.y*a.y + c,      oc*a.y*a.z + a.x*s,
                oc*a.z*a.x + a.y*s,  oc*a.y*a.z - a.x*s,  oc*a.z*a.z + c
            );
        }

        void mainImage(out vec4 fragColor, in vec2 fragCoord) {
            vec2 r = iResolution.xy;
            vec2 FC = fragCoord;
            float t = iTime;
            vec4 o = vec4(0, 0, 0, 1);
            
            float g = 0.0;
            float e = 0.0;
            float s = 0.0;
            
            for(int k = 0; k < 99; k++) {
                vec3 p = vec3(
                    (FC.xy - 0.5 * r) / r.y * uCamZoom + vec2(0, uCamY), 
                    g
                );
                
                p = p * rotate3D(-1.1 - cos(t * 0.15) * 0.1, vec3(1.0, 11.0 + sin(t) * 0.15, -1.5));
                s = 2.0; 
                for (int j = 0; j < 19; j++) { 
                    float dotP = dot(p, p * 0.51);
                    dotP = max(dotP, 0.0001); 
                    e = uScale / dotP;
                    s *= e;
                    p = vec3(uFold1X, uFold1Y, uFold1Z) - abs(abs(p) * e - vec3(3.0, 4.0, 3.0));
                }
                g += p.y / s;
                float intensity = log2(s) / exp(e); 
                vec3 colVal = 0.01 - hsv(uColorFreq, g * 0.016 - e * uColorSpeed, intensity / 200.0);
                o.rgb += colVal;
            }
            fragColor = o;
        }

        void main() {
            mainImage(outColor, gl_FragCoord.xy);
            outColor.a = 1.0;
        }
    </script>

    <!-- Core App Logic (AS-IS with name string update for download) -->
    <script>
        const canvas = document.getElementById('glcanvas');
        const gl = canvas.getContext('webgl2', { preserveDrawingBuffer: true }); 
        const overlay = document.getElementById('transition-overlay');
        
        if (!gl) {
            document.body.innerHTML = "<h1 style='color:white; text-align:center; padding-top:20px;'>WebGL 2.0 Not Supported</h1>";
            throw new Error("WebGL 2.0 required");
        }

        const defaults = {
            uScale: 7.1,
            uFold1X: 0.08,
            uFold1Y: 4.0,
            uFold1Z: -1.0,
            uColorFreq: 0.1,  
            uColorSpeed: 0.3,
            uCamZoom: 5.0,
            uCamY: 9.0
        };

        const config = {
            uScale:     { val: defaults.uScale, min: 6.0, max: 8.5, step: 0.01, name: "Fractal Scale" },
            uFold1X:    { val: defaults.uFold1X, min: -0.5, max: 0.5, step: 0.01, name: "Fold X" },
            uFold1Y:    { val: defaults.uFold1Y, min: 3.0, max: 4.0, step: 0.01, name: "Fold Y" },
            uFold1Z:    { val: defaults.uFold1Z, min: -1.43, max: 0.0, step: 0.01, name: "Fold Z" },
            uColorFreq: { val: defaults.uColorFreq, min: 0.0, max: 1.0, step: 0.01, name: "Color Hue" },
            uColorSpeed:{ val: defaults.uColorSpeed, min: 0.0, max: 1.0, step: 0.01, name: "Color Shift" },
            uCamZoom:   { val: defaults.uCamZoom, min: 3.0, max: 8.0, step: 0.1, name: "Camera Zoom" },
            uCamY:      { val: defaults.uCamY, min: 5.0, max: 12.0, step: 0.1, name: "Camera Y" }
        };

        const state = {
            startTime: Date.now(),
            isMenuOpen: false,
            isRandomizing: false,
            autoAdvance: false,
            autoInterval: 5000,
            lastAutoTime: 0
        };

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error("Shader Error:", gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        const vsSource = document.getElementById('vs').text.trim();
        const fsSource = document.getElementById('fs').text.trim();
        const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);
        const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
        const program = gl.createProgram();
        gl.attachShader(program, vs);
        gl.attachShader(program, fs);
        gl.linkProgram(program);
        gl.useProgram(program);

        const positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
        const positionLocation = gl.getAttribLocation(program, 'position');
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

        const uLocs = {
            iResolution: gl.getUniformLocation(program, "iResolution"),
            iTime: gl.getUniformLocation(program, "iTime"),
        };
        for(let key in config) {
            uLocs[key] = gl.getUniformLocation(program, key);
        }

        const controlsContainer = document.getElementById('controls-container');
        
        function createControls() {
            controlsContainer.innerHTML = '';
            for(let key in config) {
                const c = config[key];
                const group = document.createElement('div');
                group.className = 'control-group';
                
                const label = document.createElement('label');
                label.innerHTML = `<span>${c.name}</span><span id="val-${key}">${c.val.toFixed(2)}</span>`;
                
                const input = document.createElement('input');
                input.type = 'range';
                input.min = c.min;
                input.max = c.max;
                input.step = c.step;
                input.value = c.val;
                input.id = `input-${key}`;
                
                input.addEventListener('input', (e) => {
                    config[key].val = parseFloat(e.target.value);
                    document.getElementById(`val-${key}`).textContent = config[key].val.toFixed(2);
                });

                group.appendChild(label);
                group.appendChild(input);
                controlsContainer.appendChild(group);
            }
        }

        function updateUIValues() {
            for(let key in config) {
                const el = document.getElementById(`input-${key}`);
                const txt = document.getElementById(`val-${key}`);
                if(el && txt) {
                    el.value = config[key].val;
                    txt.textContent = config[key].val.toFixed(2);
                }
            }
        }

        function resize() {
            if(canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
        }

        function randomizeParams() {
            for(let key in config) {
                const c = config[key];
                const range = c.max - c.min;
                config[key].val = c.min + (Math.random() * range);
            }
            updateUIValues();
        }

        function resetParams() {
            config.uScale.val = defaults.uScale;
            config.uFold1X.val = defaults.uFold1X;
            config.uFold1Y.val = defaults.uFold1Y;
            config.uFold1Z.val = defaults.uFold1Z;
            config.uColorFreq.val = defaults.uColorFreq;
            config.uColorSpeed.val = defaults.uColorSpeed;
            config.uCamZoom.val = defaults.uCamZoom;
            config.uCamY.val = defaults.uCamY;
            updateUIValues();
        }

        async function triggerRandomization() {
            if(state.isRandomizing) return;
            state.isRandomizing = true;

            overlay.style.opacity = 1;
            await new Promise(r => setTimeout(r, 400));
            randomizeParams();
            await new Promise(r => setTimeout(r, 100));
            overlay.style.opacity = 0;
            setTimeout(() => { state.isRandomizing = false; }, 400);
        }

        function toggleMenu(forceClose = false) {
            const btn = document.getElementById('menu-btn');
            const panel = document.getElementById('settings-panel');
            
            if (forceClose) {
                state.isMenuOpen = false;
            } else {
                state.isMenuOpen = !state.isMenuOpen;
            }

            if (state.isMenuOpen) {
                btn.classList.add('open');
                panel.classList.add('open');
                btn.setAttribute('aria-expanded', 'true');
            } else {
                btn.classList.remove('open');
                panel.classList.remove('open');
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        document.addEventListener('click', (e) => {
            const path = e.composedPath();
            const isClickInsideMenu = path.some(el => el.id === 'settings-panel' || el.id === 'menu-btn');
            
            if (!isClickInsideMenu) {
                if (state.isMenuOpen) {
                    toggleMenu(true);
                } else {
                    triggerRandomization();
                }
            }
        });

        document.getElementById('menu-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });

        document.addEventListener('keydown', (e) => {
            if(e.key === "Escape" && state.isMenuOpen) toggleMenu(true);
        });

        document.getElementById('btn-random').addEventListener('click', (e) => {
            e.stopPropagation();
            triggerRandomization();
        });
        
        document.getElementById('btn-reset').addEventListener('click', (e) => {
             e.stopPropagation();
             resetParams(); 
             overlay.style.opacity = 0.5;
             setTimeout(() => overlay.style.opacity = 0, 200);
        });

        document.getElementById('auto-advance').addEventListener('change', (e) => {
            state.autoAdvance = e.target.checked;
            state.lastAutoTime = Date.now();
        });
        
        document.getElementById('auto-interval').addEventListener('input', (e) => {
            state.autoInterval = parseInt(e.target.value) * 1000;
            document.getElementById('interval-val').textContent = e.target.value;
        });

        document.getElementById('btn-export').addEventListener('click', (e) => {
            e.stopPropagation();
            const btn = document.getElementById('btn-export');
            const originalText = btn.textContent;
            btn.textContent = "Processing...";
            
            requestAnimationFrame(() => {
                const originalWidth = canvas.width;
                const originalHeight = canvas.height;
                
                canvas.width = 3840;
                canvas.height = 2160;
                gl.viewport(0, 0, 3840, 2160);

                const time = (Date.now() - state.startTime) * 0.001;
                
                gl.uniform2f(uLocs.iResolution, 3840, 2160);
                gl.uniform1f(uLocs.iTime, time);
                for(let key in config) {
                    gl.uniform1f(uLocs[key], config[key].val);
                }
                
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `beneath_air_${Date.now()}.png`;
                    a.click();
                    
                    canvas.width = originalWidth;
                    canvas.height = originalHeight;
                    gl.viewport(0, 0, originalWidth, originalHeight);
                    btn.textContent = originalText;
                }, 'image/png');
            });
        });

        function render() {
            if(state.autoAdvance) {
                const now = Date.now();
                if(now - state.lastAutoTime > state.autoInterval) {
                    triggerRandomization();
                    state.lastAutoTime = now;
                }
            }

            resize();
            const time = (Date.now() - state.startTime) * 0.001;
            gl.uniform2f(uLocs.iResolution, canvas.width, canvas.height);
            gl.uniform1f(uLocs.iTime, time);
            for(let key in config) {
                gl.uniform1f(uLocs[key], config[key].val);
            }
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            requestAnimationFrame(render);
        }

        createControls();
        resetParams(); 
        render();

    </script>
</body>
</html>